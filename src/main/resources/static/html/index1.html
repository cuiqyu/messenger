<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="renderer" content="webkit">
	<meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
	<title>华鑫e融</title>
	<link rel="stylesheet" href="../css/font-awesome.min.css">
	<link rel="stylesheet" href="../css/mobiscroll-2.13.2.full.min.css">
	<link rel="stylesheet" href="../css/index.css">
	<style>
		#cover {
			position: absolute;
			left: 0px;
			top: 0px;
			background: rgba(0, 0, 0, 0.8);
			width: 100%;
			/*宽度设置为100%，这样才能使隐藏背景层覆盖原页面*/
			filter: alpha(opacity=60);
			/*设置透明度为60%*/
			opacity: 0.6;
			/*非IE浏览器下设置透明度为60%*/
			display: none;
			z-Index: 999;
		}

		#modal {
			border-radius: 15px;
			padding: 12px;
			position: absolute;
			top: 50%;
			transform: translateY(-50%);
			left: 50%;
			transform: translateX(-50%);
			width: 80%;
			height: 230px;
			background-color: #fff;
			display: none;
			cursor: pointer;
			z-Index: 9999;
		}

		#close {
			width: 100%;
			height: 50px;
			text-align: center;
			line-height: 50px;
			border-top: 1px solid #ccc;
		}

		#modal-title {

			text-align: center;
			height: 50px;
			line-height: 50px;
		}

		#modal-content {
			padding: 10 10px;
			height: 110px;
			color: #aaa;
			font-size: 18px;
			line-height: 30px;
		}
	</style>
</head>

<body id="bg-blue">
	<!--遮罩层居中-->
	<div id="cover"></div>
	<div id="modal">
		<div id="modal-title">
			温馨提示
		</div>
		<div id="modal-content">
			提交成功！请保持手机畅通，您的专属顾问会在1小时内与您联系！（工作时间09:00~18:00）
		</div>
		<div id="close">确定</div>
	</div>
	<!-- 头图 -->
	<header class="headImg">
		<!-- <img src="http://www.11ec.cn/themes/crm1/public/assets/images/2bcc5068a03d476aaeac09406c7b05c1.jpg" alt="">-->
		<img src="../images/header.jpg" class="img-responsive" alt="Cinque Terre" style='width:100%;height:auto;'>
	</header>
	<!-- 表单 -->
	<form class="newForm">
		<div class="cons">
			<!-- 姓名 -->
			<div class="conItem">
				<img src="../images/wo.png" alt="" class="icon">
				<input type="text" class="inputItem" name="username" id="name" placeholder="您的姓名">
			</div>
			<!-- 手机号 -->
			<div class="conItem">
				<img src="../images/phone.png" alt="" class="icon">
				<input type="text" class="inputItem" name="tel" id="tel" onkeyup="value=value.replace(/[^\d]/g,'')"
					maxlength="11" placeholder="您的手机号">
				<input type="button" id="codeBtn" value="获取验证码" onclick="settime(this)"
					style="background-color:#03006d;color:#fff;">
			</div>
			<!-- 验证码 -->
			<div class="conItem">
				<img src="../images/phone.png" alt="" class="icon">
				<input type="text" class="inputItem" name="code" id="code" onkeyup="value=value.replace(/[^\d]/g,'')"
					maxlength="11" placeholder="验证码">
			</div>

			<!-- 意向金额 -->
			<div class="conItem">
				<img src="../images/money.png" alt="" class="icon">
				<select name="price" id="price" class="inputItem" style="border:none;outline: none;background:#fff;">
					<!--<option value='0'>请选择贷款金额</option>-->
					<option value='30000'>3万</option>
					<option value='50000'>5万</option>
					<option value='100000'>10万</option>
					<option value='250000'>25万以上</option>
				</select>
			</div>
			<!-- 城市选择 -->
			<div class="conItem" id="city_3">
				<img src="../images/city.png" alt="" class="icon">
				<select class="prov inputItem"
					style="width:49%;float:left;margin-right:2%;border:none;outline: none;background:#fff;"></select>
				<select class="city inputItem" style="width:49%;float:left;border:none;outline: none;background:#fff;"
					disabled="disabled"></select>
			</div>
			<p class="tip">完善一下信息可提升您的放款率(可多选)</p>
		</div>
		<!-- 多选 -->
		<div class="select-part">
			<div class="checkbox-wrap">
				<label for="one" class="checkbox-item">
					<span>工资</span>
					<input type="checkbox" name="title[]" class="checkbox" id="one" value="工资">
				</label>
				<label for="one" class="checkbox-item">
					<span>房子</span>
					<input type="checkbox" name="title[]" class="checkbox" id="one" value="房子">
				</label>
				<label for="one" class="checkbox-item">
					<span>车子</span>
					<input type="checkbox" name="title[]" class="checkbox" id="one" value="车子">
				</label>
				<label for="one" class="checkbox-item">
					<span>公积金</span>
					<input type="checkbox" name="title[]" class="checkbox" id="one" value="公积金">
				</label>
				<label for="one" class="checkbox-item">
					<span>营业执照</span>
					<input type="checkbox" name="title[]" class="checkbox" id="one" value="营业执照">
				</label>
				<label for="one" class="checkbox-item">
					<span>保单</span>
					<input type="checkbox" name="title[]" class="checkbox" id="one" value="保单">
				</label>
			</div>
		</div>
		<div class='conItem'>

		</div>
		<div class="btn-wrap">
			<div class='xy' style='color:#00BFFF;position:relative;top:-15px;'>
				<input type="checkbox" name="" id='xy' value='1'
					style="-webkit-appearance:checkbox;width:15px;height:13px;" checked="checked"><a href="#"
					style="margin-left:5px;font-size:13px;">提交表示同意《保密协议和隐私协议》</a>
			</div>
			<input type="hidden" name="type" value="7">
			<a class="btn" id="submit" href="###">看 看 我 能 借 多 少</a>
		</div>
	</form>
	<!-- 优势 -->
	<section class="advantage">
		<div class="title">
			<h3>我们的优势</h3>
			<p class="sub-title">
				<span>Our Advantage</span>
			</p>
		</div>
		<div class="content">
			<div class="adv-item">
				<a href="###" class="advImg">
					<img src="../images/a01.png" alt="">
				</a>
				<div class="advCon">
					<p>数据全面</p>
					<span>覆盖全网95%以上平台机构</span>
				</div>
			</div>
			<div class="adv-item">
				<a href="###" class="advImg">
					<img src="../images/a02.png" alt="">
				</a>
				<div class="advCon">
					<p>安全保密</p>
					<span>只接受本人授权查询使用</span>
				</div>
			</div>
			<div class="adv-item">
				<a href="###" class="advImg">
					<img src="../images/a03.png" alt="">
				</a>
				<div class="advCon">
					<p>自由分期</p>
					<span>6/12/36/48期任选</span>
				</div>
			</div>
			<div class="adv-item">
				<a href="###" class="advImg">
					<img src="../images/a04.png" alt="">
				</a>
				<div class="advCon">
					<p>银行放款</p>
					<span>最快2小时到账</span>
				</div>
			</div>
		</div>
	</section>
	<!-- 底部 -->
	<footer>
		市场有风险，选择需谨慎 请根据个人能力合理贷款，理性消费，避免逾期 贷款额度、放款时间以实际审批结果为准 </footer>

	<script src="../js/jquery.min.js"></script>
	<script src="../js/mobiscroll-2.13.2.full.min.js"></script>
	<script type="text/javascript" src="../js/jquery.cityselect.js"></script>
	<script>
		let apiName = 'https://api.eteams.cn';
		//code码验证
		function authorize() {
			$.get(apiName + "/oauth2/authorize?corpid=bcb0da1b7e81d73d3d4288690b7e96c2&response_type=code&state=a", function (
				msg) {
				console.log(msg);
				if (msg.errmsg==="success") {
					window.sessionStorage.setItem('authorize', JSON.stringify({
						code: msg.code,
						expiresin: new Date().getTime() + (10*60*1000) //expires_in 的单位是秒，变成毫秒要*1000 10分钟作废
					}));
					getToken();
				}else{
					alert('接口访问错误');
				}
			});
		};

		//判断token
		function getToken() {
			if (window.sessionStorage.authorize) {
				const whether = new Date().getTime() < JSON.parse(window.sessionStorage.authorize).expiresin; //缓存中的 expires_in 字段是否过期，true表示没过期，false表示过期
				if (whether) { //code未到期
					$.ajax({
						type: "post",
						url: apiName +
							"/oauth2/access_token?app_key=ae825caafd21ac69d52f0ce264c81228&app_secret=b44ab81be965708310e517f01084d16a&grant_type=authorization_code&code=" +
							JSON.parse(window.sessionStorage.authorize).code,
						contentType: "application/x-www-form-urlencoded",
						success: function (data) {
							console.log(data);
							window.sessionStorage.setItem('tokenData', JSON.stringify({
								token: data.accessToken,
								expiresin: new Date().getTime() + (data.expires_in *
									1000) //expires_in 的单位是秒，变成毫秒要*10000 2小时作废
							}));
							userId();
						}
					})
				}


			} else {
				authorize();
			}

		}
		userId();
		//判断userId
		function userId() {
			if (window.sessionStorage.tokenData) {
				const whether = new Date().getTime() < JSON.parse(window.sessionStorage.tokenData)
					.expiresin; //缓存中的 expires_in 字段是否过期，true表示没过期，false表示过期
				if (whether) { //token未到期
					$.get(apiName + "/user/v2/findUser?access_token=" + JSON.parse(window.sessionStorage.tokenData).token + "&name=陈", function (msg) {
						console.log(JSON.stringify(msg.data));
						JSON.stringify(msg.data);
						let userId = String(msg.data[0].userid);
						window.sessionStorage.setItem('userId', userId);
					});
				} else {
					console.log('token已到期');
					getToken(); //获取token字段
				}
			} else {
				getToken(); //获取token字段
			}

		}
		//新增客户
		function create(entity) {
			let userId = Number(window.sessionStorage.getItem('userId'));
			console.log('userId+++'+userId+typeof(userId));
			$.ajax({
				type: "post",
				url: apiName + "/crm/v2/create",
				contentType: "application/x-www-form-urlencoded",
				data:{access_token:JSON.parse(window.sessionStorage.tokenData).token,userid:userId,module:'customer',entity:JSON.stringify(entity)},
				success: function (data) {
					console.log(data);
					
				}
			})

		}


		$('#xy').click(function () {
			var a = $(this).val();
			if (a == 1) {
				//设置为未选中状态
				$(this).val(0);
				$(this).attr('checked', false);
			} else if (a == 0) {
				//设置为选中状态
				$(this).val(1);
				$(this).attr('checked', true);
			}
		});


		$('#submit').click(function () {
			var is_yes = true;
			let name = $("#name").val();
			let tel = $("#tel").val();
			let code = $("#code").val();
			let price = $("#price").find("option:selected").text();
			let prov = $(".prov").find("option:selected").text();
			let city = $(".city").find("option:selected").text();
			if (!name) {
				alert('请输入姓名');
				is_yes = false;
				return false;
			}
			if (isPhoneNo(tel) == false) {
				alert("请输入正确电话号");
				is_yes = false;
				return false;
			}
			if(!code || !window.sessionStorage.messageCode){
				alert("请输入验证码");
				is_yes = false;
				return false;

			}else{
				console.log(JSON.parse(window.sessionStorage.messageCode).expiresin-new Date().getTime());
				const whether = new Date().getTime() < JSON.parse(window.sessionStorage.messageCode).expiresin; //缓存中的 expires_in 字段是否过期，true表示没过期，false表示过期
				console.log(whether);
				  if (whether) {//token未到期
					console.log(typeof(code));
					console.log(JSON.parse(window.sessionStorage.messageCode).code);
                     if(code !== JSON.parse(window.sessionStorage.messageCode).code){
						alert("请输入正确验证码");
				        is_yes = false;
				         return false;
					 }
				  }else{
					alert("请输入正确验证码");
				    is_yes = false;
				    return false;

				  }
			}

			if (is_yes) {
				let entity = {
					"name": "",
					"manager": {
						"name": name
					},
					"customerStatus": {
						"name": "基础客户"
					},
					"customerType": {
						"name": "客户"
					},
					"customerIndustry": {
						"name": "金融行业"
					},
					"customerRegion": {
						"name": prov
					},
					"customerFax": "",
					"customerEmail": "",
					"customerZipCode": "",
					"customerTelephone": tel,
					"customerWebsite": "",
					"customerAddress": prov + city,
					"customerDescription": ""
				}
				create(entity);

			}
		});

		function isPhoneNo(phone) {
			var pattern = /^1[34578]\d{9}$/;
			return pattern.test(phone);
		}

		$('#close').click(function () {
			$('#modal').hide();
			$('#cover').hide();
		});

		//获取手机屏幕高度
		var h = $(document.body).height();
		$('#cover').css('height', '' + h + 'px');

		$(function () {
			$("#city_3").citySelect({
				prov: "江苏",
				city: "南京"
			});
		})
		//ajax
		//省会
		$('.prov').change(function () {
			var prov = $(this).val();
		});
		//城市
		$('.city').change(function () {
			var city = $(this).val();
		});


		// 验证码倒计时
		var countdown = 60; //设置时间
		function settime(obj) {
			if (obj.disabled != true) {
				var tel = $('#tel').val();
				if (isPhoneNo(tel) == false) {
					alert("请输入正确电话号");
					return false;
				}
				$.ajax({
					type: "post",
					url: "/messenger/sms/sendMessage",
					contentType: "application/json",
					data: JSON.stringify({'cellphone':tel}),
                    dataType: "json",
					success: function (data) {
						console.log(data);
						if(data.message==='成功'){
							window.sessionStorage.setItem('messageCode', JSON.stringify({
								code: data.data,
								expiresin: new Date().getTime() + (15*60*1000) //expires_in 的单位是秒，变成毫秒要*1000 10分钟作废
					      }));
							
						}
						
					}
			   })
				
			}
			if (countdown == 0) {
				obj.removeAttribute("disabled");
				obj.value = "重新发送验证码";
				countdown = 60;
				return;
			} else {
				obj.setAttribute("disabled", true);
				obj.value = "重新发送(" + countdown + ")";
				countdown--;
			}

			setTimeout(function () {
				settime(obj)
			}, 1000)
		}

		$(function () {
			// 岗位切换
			$("#cities").mobiscroll().treelist({
				theme: "android-ics light",
				lang: "zh",
				display: 'bottom',
				inputClass: 'tmp',
				defaultValue: [Math.floor($('#cities li').length / 2)],
				headerText: '城市',
				onSelect: function (valueText) {
					var m = $(this).find("li").eq(valueText).html();
					console.log(m, $('.tmp'));
					$('.tmp').val('');
					$('.tmp').prev().prev().val(m);
				}
			});
			// 多选
			$('.checkbox').on('click', function () {
				if ($(this).prop("checked")) {
					$(this).parents('.checkbox-item').addClass('active')
				} else {
					$(this).parents('.checkbox-item').removeClass('active')
				}
			})
		})
	</script>
</body>

</html>